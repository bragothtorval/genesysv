
{% load crispy_forms_tags %}
{% load search_tags %}
{% load staticfiles %}
{% load humanize %}


{% block content %}
{% if debug %}
    <h4>Total Hits: {{total|intcomma}}</h4>
    <h4>Query String Generation Time: {{content_generate_time}}</h4>
    <h4>Database Took: {{took}} ms</h4>
    <h4>Post Processing Time: {{after_results_time}}</h4>
    <h4>Total Time: {{total_time}}</h4>

    {% for ele in used_keys %}
        {{ele.0}}: <strong>{{ele.1}}</strong><br>
    {% endfor %}
    <br>
{% endif %}

<div class="well">
    <a id="back-to-top-container" class="btn btn-primary" role="button"><i class="fa fa-long-arrow-left" aria-hidden="true"></i> Back</a>
    <a class="btn btn-primary " role="button" href="/search"><i class="fa fa-search" aria-hidden="true"></i> New Search</a>
    {% if user.is_authenticated %}
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#saveResultsModal"><i class="fa fa-star" aria-hidden="true"></i> Save Search Results</button>
    {% endif %}
    {% if gene_mania_link %}
        <a class="btn btn-primary " target="_blank" role="button" href="{{gene_mania_link}}"><i class="fa fa-search" aria-hidden="true"></i>GeneMania </a>
    {% endif %}
    <a id="download-result-button" class="btn btn-primary pull-right" role="button" href="#"><i class="fa fa-download" aria-hidden="true"></i> Download</a>
    <form id="download-result-form" role="form"  method="POST" action="{% url 'download-result' %}">
        {% csrf_token %}
        <input style="display: none;" type="hidden" name="search_log_obj_id" value="{{search_log_obj_id}}">
    </form>
    <div class="clearfix"></div>
</div>


<div class="panel panel-primary">
<div class="panel-body">
<div class="table-responsive">
    <table id="result-table" class="table display compact" cellspacing="0" width="100%">
        <thead>
          <tr>

               {% if user.is_authenticated %}<th>Approval Status</th>{% endif %}

            {% for element in headers %}
                <th>{{element.display_text}}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
            {% for row in results %}
                <tr>
                     {% if user.is_authenticated %}
                         <td>
                        <select class="variant_approval_status selectpicker" data-width="auto" data-style="btn-link" data-width="fit" data-esid="{{row|get_value_from_dict:"es_id"}}">
                        {% for short_status, long_status in APPROVAL_STATUS_CHOICES %}
                            {% if row|get_value_from_dict:"variant_approval_status" == short_status %}
                                <option value="{{short_status}}" selected data-content="<span class='badge badge-{{short_status}}'>{{long_status}}</span>">{{long_status}}</option>
                            {% else %}
                                <option value="{{short_status}}" data-content="<span class='badge badge-{{short_status}}'>{{long_status}}</span>"></option>
                            {% endif %}
                        {% endfor %}
                         </select>

                        </td>
                    {% endif %}
                    {% for element in headers %}
                        <td>{{ row|get_value_from_dict_search:element|safe }}
                        {% if element == "refGene_symbol" %}
                            {{element}}
                        {% endif %}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

</div>
</div>

<br>


<!-- Modal -->
<div class="modal fade" id="saveResultsModal" tabindex="-1" role="dialog" aria-labelledby="saveResultsModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="saveResultsModalLabel">Save Search</h4>
      </div>
      <div class="modal-body">
         <form class="form-horizontal" action="{% url 'save-search' %}" method="POST">
            {% csrf_token %}
            {% crispy save_search_form %}
            <input type="submit" class="btn btn-submit btn-primary col-md-offset-2">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
         </form>
      </div>
    </div>
  </div>
</div>


{{variants_excluded}}

<script>
    $(document).ready(function() {
        // $('#result-table').destroy();
        $('#result-table').DataTable({
            "iDisplayLength": 25,
            "bSortClasses": false
        });

    });

    $('.selectpicker').selectpicker({
    });

    $("#back-to-top-container").on("click", function() {
        $('#results_div').hide()
        $('#top_container').show()
        $("#main-nav-bar > ul > li.active").removeClass("active")
        $("#li-step4").removeClass("active")
        $("#li-step3").addClass("active")
        $('#li-step3').show()
    });

    $("#download-result-button").on("click", function() {
        $("#download-result-form").submit();
    });

    $(".variant_approval_status").on("change", function() {
        var selected = $(this);
        var variant_approval_status = selected.val();
        var es_id = selected.data("esid")
        if (es_id) {
            update_variant_approval_status(es_id, variant_approval_status);
        }
        // $( "body" ).data( "foo", 52 );
    });


    function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
    function update_variant_approval_status(es_id, variant_approval_status){
    $.ajax(
        {
            headers: {'X-CSRFToken': getCookie('csrftoken')},
            type: "POST",
            url : "{% url 'update-variant-approval-status' %}",
            data: {
                    es_id: es_id,
                    variant_approval_status: variant_approval_status,
            },
            success:function(data) {
                console.log(data)
            }
        }

    );
    };

</script>

{% endblock %}
