
{% load crispy_forms_tags %}
{% load search_tags %}
{% load staticfiles %}
{% load humanize %}


{% block content %}
{% if debug %}
    <h4>Total Hits: {{total|intcomma}}</h4>
    <h4>Query String Generation Time: {{content_generate_time}}</h4>
    <h4>Database Took: {{took}} ms</h4>
    <h4>Post Processing Time: {{after_results_time}}</h4>
    <h4>Total Time: {{total_time}}</h4>

    {% for ele in used_keys %}
        {{ele.0}}: <strong>{{ele.1}}</strong><br>
    {% endfor %}
    <br>
{% endif %}


<div class="well">
    <a id="back-to-top-container" class="btn btn-primary" role="button"><i class="fa fa-long-arrow-left" aria-hidden="true"></i> Back</a>
    <a class="btn btn-primary " role="button" href="/search"><i class="fa fa-search" aria-hidden="true"></i> New Search</a>
    {% if user.is_authenticated and variant_field_exist%}
        <button id="show_review_status_button" type="button" class="btn btn-primary"><i class="fa fa-plus" aria-hidden="true"></i> Show Review Status</button>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#variantStatusReviewFilter"><i class="fa fa-filter" aria-hidden="true"></i> Select Post Query Filter</button>
    {% endif %}

    <div class="pull-right">
        {% if user.is_authenticated %}
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#saveResultsModal"><i class="fa fa-star" aria-hidden="true"></i> Save Search Results</button>
        {% endif %}
        <a id="download-result-button" class="btn btn-primary" role="button" href="#"><i class="fa fa-download" aria-hidden="true"></i> Download</a>
        <form id="download-result-form" role="form"  method="POST" action="{% url 'download-result' %}">
            {% csrf_token %}
            <input style="display: none;" type="hidden" name="search_log_obj_id" value="{{search_log_obj_id}}">
            <input id="download_review_status_to_filter" style="display: none;" type="hidden" name="download_review_status_to_filter" value="false">
        </form>
    </div>

    <div class="clearfix"></div>
</div>


<div class="panel panel-primary">
    <div class="panel-body">
        <div class="table-responsive">
            <table id="result-table" class="table display compact" cellspacing="0" width="100%">
                <thead>
                  <tr>
                    {% if show_review_status and user.is_authenticated %}<th>Review Status</th>{% endif %}

                    {% for element in headers %}
                        <th>{{element.display_text}}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                    {% for row in results %}
                        <tr>
                             {% if show_review_status and user.is_authenticated %}
                                <td>
                                    <select class="variant_review_status selectpicker" data-width="auto" data-style="btn-link" data-width="fit" data-variant="{{row|get_value_from_dict:"Variant"}}" data-esid="{{row|get_value_from_dict:"es_id"}}" data-datasetid="{{dataset_obj.id}}">
                                    {% for short_status, long_status in REVIEW_STATUS_CHOICES %}
                                        {% if row|get_value_from_dict:"variant_review_status" == short_status %}
                                            <option value="{{short_status}}" selected data-content="<span class='badge badge-{{short_status}}'>{{long_status}}</span>">{{long_status}}</option>
                                        {% else %}
                                            <option value="{{short_status}}" data-content="<span class='badge badge-{{short_status}}'>{{long_status}}</span>"></option>
                                        {% endif %}
                                    {% endfor %}
                                     </select>
                                </td>
                            {% endif %}
                            {% for element in headers %}
                                <td>{{ row|get_value_from_dict_search:element|safe }}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}

                </tbody>
            </table>
            {% if show_review_status %}
                <div class="panel panel-default">
                    <div class="panel-body">
                        <span class='badge badge-approved add_badge_margin_remove_hover'><i class="fa fa-check" aria-hidden="true"></i></span> Approved
                        <span class='badge badge-rejected add_badge_margin_remove_hover'><i class="fa fa-times" aria-hidden="true"></i></span> Rejected
                        <span class='badge badge-pending add_badge_margin_remove_hover'><i class="fa fa-question" aria-hidden="true"></i></span> Pending
                        <span class='badge badge-not_reviewed add_badge_margin_remove_hover'>--</span> Not Reviewed
                    </div>
                </div>
            {% endif %}
            {% if gene_mania_link %}
                <div class="panel panel-default">
                    <div class="panel-body">
                        <a style="font-size: 18px" target="_blank" role="button" href="{{gene_mania_link}}"><i class="fa fa-external-link-square fa-1x" aria-hidden="true"></i> Send selected genes to GeneMANIA</a>
                    </div>
                </div>
            {% endif %}

        </div>
    </div>
</div>

{% if variants_excluded %}
<div class="panel panel-primary">
  <div class="panel-heading">
    <h3 class="panel-title">Variants Excluded from Search <span class="badge">{{variants_excluded|length}}</span></h3>
  </div>
  <div class="panel-body">
    {% for dataset_id, es_id, variant in variants_excluded %}
        <a target="_blank" href="/search/variant/{{dataset_id}}/{{es_id}}/">{{variant}}</a><br>
    {% endfor %}
  </div>
</div>

{% endif %}

<br>


<!-- Modal -->
<div class="modal fade" id="saveResultsModal" tabindex="-1" role="dialog" aria-labelledby="saveResultsModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="saveResultsModalLabel">Save Search</h4>
      </div>
      <div class="modal-body">
         <form class="form-horizontal" action="{% url 'save-search' %}" method="POST">
            {% csrf_token %}
            {% crispy save_search_form %}
            <input type="submit" class="btn btn-submit btn-primary col-md-offset-2">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
         </form>
      </div>
    </div>
  </div>
</div>


<!-- Modal -->
<div class="modal fade" id="variantStatusReviewFilter" tabindex="-1" role="dialog" aria-labelledby="variantStatusReviewFilterLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="variantStatusReviewFilterLabel">Select Review Status to Show</h4>
      </div>
      <div class="modal-body">
            <form id="review_status_to_filter_form">
                {% crispy review_status_form %}
                <button id="post_query_filter_form_submit" type="submit" data-dismiss="modal" data-backdrop="false" class="btn btn-submit btn-primary">Apply</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </form>
      </div>
    </div>
  </div>
</div>


<!-- Modal -->
<div class="modal fade" id="confirmFilter" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-body">
        <p id="confirmFilterModalP">Only variants you have selected to show will be downloaded.</p>
        <div class="checkbox">
          <label><input id="show_message" type="checkbox" value="">Do not show this message again?</label>
        </div>
        <button type="button" class="btn btn-primary" data-dismiss="modal"><i class="fa fa-download" aria-hidden="true"></i> Download</button>
      </div>
    </div>
  </div>
</div>



<script>

    function get_options(input_string) {
        input_string = input_string.split('&');
        var options = new Array();
        for (i = 0; i < input_string.length; i++) {
            var text = input_string[i];
            if (text.indexOf('review_status_to_filter')  >= 0) {
                text = text.split('=')[1];
                options.push(text)
            }
        }

        if (options.length == 0) {
            return ""
        }
        else {
            return options.join(', ');
        }
    }

    $(document).ready(function() {
        // $('#result-table').destroy();

        $('#result-table').DataTable({
            "iDisplayLength": 25,
            "bSortClasses": false
        });


        if ($("#show_review_status").val() == "true") {
            $("#show_review_status_button").html('<i class="fa fa-minus" aria-hidden="true"></i> Hide Review Status')
        } else {
            $("#show_review_status_button").html('<i class="fa fa-plus" aria-hidden="true"></i> Show Review Status')
        }


    });


    $("#back-to-top-container").on("click", function() {
        $('#results_div').hide()
        $('#top_container').show()
        $("#main-nav-bar > ul > li.active").removeClass("active")
        $("#li-step4").removeClass("active")
        $("#li-step3").addClass("active")
        $('#li-step3').show()
    });

    $('#confirmFilter').on('hidden.bs.modal', function () {
        // $("#download-result-form").submit();
        if ($("#show_message").is(":checked") === true) {
            localStorage.setItem("gdw_show_download_message", "false");
        } else {
            localStorage.setItem("gdw_show_download_message", "true");
        }
        $("#download-result-form").submit();
    });

    $("#download-result-button").on("click", function() {
        var form_data = $('#review_status_to_filter_form').serialize();
        // var options = get_options(form_data);
        $("#download_review_status_to_filter").val(form_data)
        var options = get_options(form_data);
        console.log(options)
        console.log('test2')
        if (localStorage.getItem("gdw_show_download_message") === "false") {
            console.log('test')
            $("#download-result-form").submit();

        } else {
            if (options !== "") {
                $('#confirmFilter').modal('show');
            } else {
                $("#download-result-form").submit();
            }
        }


    });

    $('.selectpicker').selectpicker({
    });

    $(".variant_review_status").on("change", function() {
        var selected = $(this);
        var variant_review_status = selected.val();
        var es_id = selected.data("esid");
        var variant = selected.data("variant");
        var datasetid = selected.data("datasetid");
        if (es_id && variant ) {
            update_variant_review_status(es_id, variant, datasetid, variant_review_status);
        }
        // $( "body" ).data( "foo", 52 );
    });


    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function update_variant_review_status(es_id, variant, datasetid, variant_review_status){
        $.ajax(
            {
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                type: "POST",
                url : "{% url 'update-variant-review-status' %}",
                data: {
                        es_id: es_id,
                        variant: variant,
                        datasetid: datasetid,
                        variant_review_status: variant_review_status,
                },
                success:function(data) {
                    console.log(data)
                }
            }
        );
    };


    $("#post_query_filter_form_submit").on("click", function() {
            // console.log('test2')
        var form_data = $('#review_status_to_filter_form').serialize();
        $("#review_status_to_filter").val(form_data)
        $("#show_review_status").val("true");
        $('#variantStatusReviewFilter').modal('hide');
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        submit_via_ajax()
    });

    // $("#apply_post_query_filter").on("click", function() {
    //     $(".submit_via_ajax").trigger("click");
    // });

    $("#show_review_status_button").on("click", function() {
        if ($("#show_review_status").val() == "true") {
            $("#show_review_status").val("false");
            $("#show_review_status_button").text('<i class="fa fa-plus" aria-hidden="true"></i> Show Review Status')
        } else {
            $("#show_review_status").val("true");
            $("#show_review_status_button").text('<i class="fa fa-minus" aria-hidden="true"></i> Hide Review Status')
        }

        submit_via_ajax()
    });

    </script>

{% endblock %}
