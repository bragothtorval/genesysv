{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load staticfiles %}
{% load subject_report_tags %}


{% block head %}
{{ wizard.form.media }}
{% endblock %}

{% block title %}
    Step 4 Subject Report
{% endblock %}

{% block content %}
<p>Step {{ wizard.steps.step1 }} of {{ wizard.steps.count }}</p>

<form action="" method="post">{% csrf_token %}
    <ul class="list-inline">
        <li><button class="btn btn-default" name="wizard_goto_step" type="submit" value="{{ wizard.steps.prev }}"><i class="fa fa-long-arrow-left"></i> Previous</button></li>
        {% if hits %}
            <li><button class="btn btn-primary next-btn" name="wizard_goto_step" type="submit" value="Next" disabled>Next <i class="fa fa-long-arrow-right"></i></button></li>
        {% endif %}
    </ul>


    {% if not hits %}
        No deleterious variants found for {{subject}}. Please go back to previous step.

    {% else %}
            {{ wizard.management_form|crispy }}
    {% if wizard.form.forms %}
        {{ wizard.form.management_form|crispy }}
        {% for form in wizard.form.forms %}
            {{ form|crispy }}
        {% endfor %}
    {% else %}
        {% if wizard.form.errors  %}
            <div class="alert alert-danger alert-dismissible" role="alert">
              <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              You must pick at least one variant to generate the report!
            </div>
        {% endif %}
        <div class="panel panel-primary">
            <div class="panel-body">
                {% if relevant_clinvar %}
                    <h3>Variants Relevant to Indicated for Finding Using ClinVar ({{relevant_clinvar|length}}) </h3>
                    <div class="table-responsive">
                        <table id="relevant_clinvar" class="table display compact table-striped" cellspacing="0" width="100%">
                            <thead>
                              <tr>
                                <th></th>
                                <th>Variant</th>
                                <th>Allele Frequency</th>
                                <th>Zygosity</th>
                                <th>Gene</th>
                                <th>RefSeq ID</th>
                                <th>ClinVar</th>
                                <th>ClinVar Classification</th>
                              </tr>
                            </thead>
                            <tbody>
                                {% for field, finding in wizard.form.relevant_clinvar|zip:relevant_clinvar %}
                                    <tr>
                                        <td>
                                            <div>
                                                {{ field.errors }}
                                                {{ field }} {{ field.text }}
                                            </div>
                                        </td>
                                        <td nowrap>{{finding.Variant}}</td>
                                        <td>{{finding.AF}}</td>
                                        <td>{{finding.sample.sample_GT}}</td>
                                        <td>{{finding.refGene|flatten_key:'refGene_symbol'|safe}}</td>
                                        <td>{{finding.refGene|flatten_key:'refGene_refgene_id'|safe}}</td>
                                        <td>{{finding.clinvar_20150629|flatten_key:'clinvar_20150629_CLNDBN'|safe}}</td>
                                        <td>{{finding.clinvar_20150629|flatten_key:'clinvar_20150629_CLINSIG'|safe}}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                         </table>
                    </div>
                {% endif %}
                {% if relevant_gwascatalog %}
                    <h3>Variants Relevant to Indicated for Finding Using GWAS Catalog ({{relevant_gwascatalog|length}}) </h3>
                    <div class="table-responsive">
                        <table id="relevant_gwascatalog" class="table display compact table-striped" cellspacing="0" width="100%">
                            <thead>
                              <tr>
                                <th></th>
                                <th>Variant</th>
                                <th>Allele Frequency</th>
                                <th>Zygosity</th>
                                <th>Gene</th>
                                <th>RefSeq ID</th>
                                <th>GWAS Catalog</th>
                              </tr>
                            </thead>
                            <tbody>
                                {% for field, finding in wizard.form.relevant_gwascatalog|zip:relevant_gwascatalog %}
                                    <tr>
                                        <td>
                                            <div>
                                                {{ field.errors }}
                                                {{ field }} {{ field.text }}
                                            </div>
                                        </td>
                                        <td nowrap>{{finding.Variant}}</td>
                                        <td>{{finding.AF}}</td>
                                        <td>{{finding.sample.sample_GT}}</td>
                                        <td>{{finding.refGene|flatten_key:'refGene_symbol'|safe}}</td>
                                        <td>{{finding.refGene|flatten_key:'refGene_refgene_id'|safe}}</td>
                                        <td>{{finding.gwasCatalog}}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                         </table>
                    </div>
                 {% endif %}

                {% if not_relevant_clinvar %}
                    <h3>Some Incidental Findings Using ClinVar ({{not_relevant_clinvar|length}}) </h3>
                    <div class="table-responsive">
                        <table id="not_relevant_clinvar" class="table display compact table-striped" cellspacing="0" width="100%">
                            <thead>
                              <tr>
                                <th></th>
                                <th>Variant</th>
                                <th>Allele Frequency</th>
                                <th>Zygosity</th>
                                <th>Gene</th>
                                <th>RefSeq ID</th>
                                <th>ClinVar</th>
                                <th>ClinVar Classification</th>
                              </tr>
                            </thead>
                            <tbody>
                                {% for field, finding in wizard.form.not_relevant_clinvar|zip:not_relevant_clinvar %}
                                    <tr>
                                        <td>
                                            <div>
                                                {{ field.errors }}
                                                {{ field }} {{ field.text }}
                                            </div>
                                        </td>
                                        <td nowrap>{{finding.Variant}}</td>
                                        <td>{{finding.AF}}</td>
                                        <td>{{finding.sample.sample_GT}}</td>
                                        <td>{{finding.refGene|flatten_key:'refGene_symbol'|safe}}</td>
                                        <td>{{finding.refGene|flatten_key:'refGene_refgene_id'|safe}}</td>
                                        <td>{{finding.clinvar_20150629|flatten_key:'clinvar_20150629_CLNDBN'|safe}}</td>
                                        <td>{{finding.clinvar_20150629|flatten_key:'clinvar_20150629_CLINSIG'|safe}}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                         </table>
                    </div>
                {% endif %}
                {% if not_relevant_gwascatalog %}
                    <h3>Some Incidental Findings Using GWAS Catalog ({{not_relevant_gwascatalog|length}}) </h3>
                    <div class="table-responsive">
                        <table id="not_relevant_gwascatalog" class="table display compact table-striped" cellspacing="0" width="100%">
                            <thead>
                              <tr>
                                <th></th>
                                <th>Variant</th>
                                <th>Allele Frequency</th>
                                <th>Zygosity</th>
                                <th>Gene</th>
                                <th>RefSeq ID</th>
                                <th>GWAS Catalog</th>
                              </tr>
                            </thead>
                            <tbody>
                                {% for field, finding in wizard.form.not_relevant_gwascatalog|zip:not_relevant_gwascatalog %}
                                    <tr>
                                        <td>
                                            <div>
                                                {{ field.errors }}
                                                {{ field }} {{ field.text }}
                                            </div>
                                        </td>
                                        <td nowrap>{{finding.Variant}}</td>
                                        <td>{{finding.AF}}</td>
                                        <td>{{finding.sample.sample_GT}}</td>
                                        <td>{{finding.refGene|flatten_key:'refGene_symbol'|safe}}</td>
                                        <td>{{finding.refGene|flatten_key:'refGene_refgene_id'|safe}}</td>
                                        <td>{{finding.gwasCatalog}}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                         </table>
                    </div>
                 {% endif %}
                </div>
            </div>
        {% endif %}

    {% endif %}



    <ul class="list-inline">
        <li><button class="btn btn-default" name="wizard_goto_step" type="submit" value="{{ wizard.steps.prev }}"><i class="fa fa-long-arrow-left"></i> Previous</button></li>
        {% if hits %}
            <li><button class="btn btn-primary next-btn" name="wizard_goto_step" type="submit" value="Next" disabled>Next <i class="fa fa-long-arrow-right"></i></button></li>
        {% endif %}
    </ul>
</form>
<p>Step {{ wizard.steps.step1 }} of {{ wizard.steps.count }}</p>
<br>

<script>
$(document).on("change", ":checkbox", (function(event){
    $(".next-btn").each(function(){
        $(this).removeAttr("disabled");
    });
    if ($("input:checkbox:checked").length == 0) {
        $(".next-btn").each(function(){
            $(this).attr("disabled", true);
        });
    }

    }));
</script>

{% endblock %}



